---
---
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Harness</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/layout.css"></link>

    <script src="https://unpkg.com/js-yaml@3.12.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@10.0.0/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/turndown@7.0.0/dist/turndown.js"></script>    

    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git@beta"></script>

    <script>

    </script>
    
    <script type="module">
     import http from 'https://unpkg.com/isomorphic-git@beta/http/web/index.js';
     import { Path, Helpers, Editor } from '/assets/js/eleventor.js';
     
     const $ = Helpers;
     console.log($);
     
     /* construct the editor */
     window.fs   = new LightningFS();
     /* this keeps track of the working directory for us */
     let CWD  = "/";

     /* tags up the load button with a click handle so that we clone the repo */
     document.querySelector('#clone').addEventListener('click', async (event) => {
       let url = $.dataFor( event.target );
       await fs.init( url );

       let opts = { fs, http, dir: CWD, url: url, force: true,
		    corsProxy: 'http://localhost:9999' };
       await git.clone( opts );
       let entries = await fs.promises.readdir("/");
       draw_directory( entries );
     }, false);

     let timer;
     let save_timer = ( content, path ) => {
       timer = setTimeout( async () => {
	 await fs.promises.writeFile(path, content);
	 draw_toolbar( path );
	 clearTimeout(timer);
       }, 500);
     };

     let draw_toolbar = async( path ) => {
       let filename = Path.file( path );
       let status   = await git.status({ fs, dir: "/", filepath: path.slice(1) });
       $.replace('ul.toolbar', $.listBuilder([ status ] ));
     };
     
     let draw_file = async( path ) => {
       let content = await fs.promises.readFile(path, { encoding: 'utf8' });

       draw_toolbar( path );

       $.replace('#editor', () => {
	 let ta  = document.createElement('textarea');
	 let txt = document.createTextNode( content );
	 ta.appendChild( txt );
	 
	 ta.addEventListener('input', () => {
	   save_timer( ta.value, path );
	 });
	 
	 return ta;
       });
     };
     
     let draw_directory = async( entries ) => {
       let node = $.listBuilder( ['..', entries].flat(), {
	 ordered: false,
	 mapped : [ 'a', (a) => {
	   a.setAttribute('href', '#');
	   a.addEventListener('click', async (event) => {
	     let text = event.target.text;
	     let path = Path.normalize( Path.join( CWD, text ) );
	     let stat = await fs.promises.stat( path );

	     if (stat.type == 'dir') {
	       let dirents = await fs.promises.readdir( path );
	       CWD = path;
	       console.log(`dirents for ${path}: `, dirents);
	       draw_directory( dirents );
	     } else {
	       /* its a file */
	       draw_file( path );
	     }
	   })
	 }, 'li' ]
       });
       
       $.replace('#listing', node);
     }
    </script>
  </head>

  <body>
    <header>
      <h1>Editor</h1>
    </header>

    <section class="repository">
      <label for="repository">Git repository: </label>
      <input id="repository" type="text" name="repository" value="https://github.com/jamesaduncan/osom.guide.git">
      <button data-for="#repository" data-property="value" id="clone">Load</button>
    </section>
    
    <section class="directory-listing">
      <section id="listing">
      </section>
    </section>

    <main>
      <ul class="toolbar"></ul>
      <section id="editor"></section>
    </main>

    <footer>
      <span class="copyright">Copyright 2021 Stance Global Ltd</span>
    </footer>
  </body>
</html>
